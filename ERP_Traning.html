<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaid.Khaled.AIS | نظام ERP التدريبي</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;700;800&display=swap" rel="stylesheet">

    <style>
        /* --- General Styling --- */
        :root {
            --primary-color: #00ffff; /* لون النيون الرئيسي */
            --secondary-color: rgba(255, 255, 255, 0.1);
            --success-color: #00e676;
            --danger-color: #ff1744;
            --warning-color: #ff9100;
            --glass-bg: rgba(0, 0, 0, 0.45);
            --glass-border: 1px solid rgba(0, 255, 255, 0.2);
            --font-family: 'Tajawal', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family);
            color: white;
            overflow-x: hidden;
            background-color: #000;
        }

        /* ---------------- خلفية 3D متحركة ---------------- */
        #space-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, #000428, #004e92, #00111f, #000000);
            background-size: 400% 400%;
            animation: gradientMove 10s ease infinite;
            z-index: -2;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }

        /* نجوم متحركة */
        .stars {
            position: absolute;
            width: 2px;
            height: 2px;
            background: white;
            animation: blink 3s infinite ease-in-out;
            opacity: 0.9;
            z-index: -1;
        }

        @keyframes blink {
            0% { opacity: 0.2; transform: scale(1) }
            50% { opacity: 1; transform: scale(1.5) }
            100% { opacity: 0.2; transform: scale(1) }
        }

        /* --- Header & Navigation --- */
        header {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 255, 255, 0.15);
            padding: 1rem 2rem;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        header h1 {
            font-weight: 900;
            font-size: 2rem;
            background: linear-gradient(45deg, #1e90ff, #00ffff);
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 15px;
        }

        nav {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .nav-btn {
            background: transparent;
            color: white;
            border: 1px solid rgba(0, 255, 255, 0.3);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 15px;
            font-family: var(--font-family);
            font-weight: bold;
            transition: 0.3s;
            backdrop-filter: blur(5px);
        }

        .nav-btn:hover {
            background: rgba(0, 255, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #0099ff, #00cccc);
            color: #000;
            border-color: transparent;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
        }

        /* --- Layout --- */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        main {
            margin-top: 20px;
        }

        .view {
            display: none;
            animation: fadeIn 0.5s;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Cards & Forms (Glassmorphism) --- */
        .card {
            background: var(--glass-bg);
            border: var(--glass-border);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 25px;
            backdrop-filter: blur(15px);
            transition: 0.3s;
        }

        .card:hover {
            box-shadow: 0 0 40px rgba(0, 255, 255, 0.1);
        }

        .card h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
            padding-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: bold;
            color: #ccc;
        }

        .form-group input,
        .form-group select {
            padding: 12px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-family: var(--font-family);
            outline: none;
            transition: 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
        }

        .form-group select option {
            background: #000;
            color: white;
        }

        .btn {
            background: linear-gradient(135deg, #02203c, #043b63);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px 25px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-family: var(--font-family);
            font-weight: bold;
            transition: 0.3s;
        }

        .btn:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            transform: scale(1.02);
        }

        .btn-success { background: linear-gradient(135deg, #1b5e20, #2e7d32); border-color: #00e676; }
        .btn-danger { background: linear-gradient(135deg, #b71c1c, #c62828); border-color: #ff1744; }
        .btn-warning { background: linear-gradient(135deg, #e65100, #ef6c00); border-color: #ff9100; }
        
        .btn-sm { padding: 6px 12px; font-size: 14px; margin: 0 2px;}

        /* --- Tables --- */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 600px;
        }

        th, td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        thead th {
            background: rgba(0, 255, 255, 0.1);
            color: var(--primary-color);
            font-weight: 800;
        }

        tbody tr:nth-of-type(even) {
            background-color: rgba(255, 255, 255, 0.02);
        }

        tbody tr:hover {
            background-color: rgba(0, 255, 255, 0.05);
        }

        .editable-input {
            width: 90%;
            padding: 5px;
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary-color);
            color: white;
            border-radius: 5px;
        }
        
        /* --- Dashboard Stats --- */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 0, 0, 0.6));
            color: white;
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(0, 255, 255, 0.2);
            text-align: center;
            transition: 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.2);
            border-color: var(--primary-color);
        }

        .stat-card h3 { 
            font-size: 1.1rem; 
            margin-bottom: 10px; 
            opacity: 0.8; 
        }
        
        .stat-card p { 
            font-size: 2.2rem; 
            font-weight: 900; 
            color: var(--primary-color);
            text-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        /* --- Notifications --- */
        .notification-container {
            position: fixed;
            top: 100px;
            left: 20px;
            z-index: 2000;
        }
        .notification {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            margin-bottom: 10px;
            border-right: 5px solid;
            backdrop-filter: blur(10px);
            animation: slideIn 0.3s ease-out;
            min-width: 280px;
        }
        .notification.success { border-color: var(--success-color); color: var(--success-color); }
        .notification.error { border-color: var(--danger-color); color: var(--danger-color); }
        .notification.warning { border-color: var(--warning-color); color: var(--warning-color); }
        
        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }
        
        /* --- Reports Styling --- */
        .report-output {
            margin-top: 20px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background-color: rgba(0,0,0,0.3);
        }
        .report-output h3 { margin-bottom: 15px; color: var(--primary-color); }
        .report-output p { margin: 8px 0; font-size: 1.1rem; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 5px; }
        .report-output .total { font-weight: bold; font-size: 1.3rem; border-top: 2px solid var(--primary-color); padding-top: 10px; margin-top: 15px; color: white; border-bottom: none;}

        /* --- Footer --- */
        footer {
            text-align: center;
            padding: 20px;
            opacity: 0.6;
            font-size: 0.9rem;
            margin-top: 40px;
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            header h1 { font-size: 1.5rem; }
            .nav-btn { font-size: 13px; padding: 8px 12px; margin-bottom: 5px; }
            .form-grid { grid-template-columns: 1fr; }
            .dashboard-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

    <div id="space-bg"></div>
    <header>
        <h1>Zaid.Khaled.AIS | نظام ERP التدريبي</h1>
        <nav>
            <button class="nav-btn active" onclick="showView('dashboard')">لوحة التحكم</button>
            <button class="nav-btn" onclick="showView('accounts')">دليل الحسابات</button>
            <button class="nav-btn" onclick="showView('sales')">المبيعات</button>
            <button class="nav-btn" onclick="showView('purchases')">المشتريات</button>
            <button class="nav-btn" onclick="showView('journal')">القيود المحاسبية</button>
            <button class="nav-btn" onclick="showView('reports')">التقارير المالية</button>
        </nav>
    </header>

    <div class="container">
        <main id="content-area">
            
            <section id="dashboard-view" class="view active">
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>إجمالي الإيرادات</h3>
                        <p id="total-revenue">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>إجمالي المصروفات</h3>
                        <p id="total-expenses">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>صافي الربح</h3>
                        <p id="net-profit">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>رصيد الصندوق</h3>
                        <p id="cash-balance">0</p>
                    </div>
                </div>
                <div class="card">
                    <h2>آخر العمليات</h2>
                    <div class="table-container">
                        <table id="recent-transactions-table">
                            <thead><tr><th>التاريخ</th><th>الوصف</th><th>المبلغ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="accounts-view" class="view">
                <div class="card">
                    <h2>إضافة حساب جديد</h2>
                    <form id="add-account-form" class="form-grid">
                        <div class="form-group"><label>رقم الحساب</label><input type="text" id="acc-number" required></div>
                        <div class="form-group"><label>اسم الحساب</label><input type="text" id="acc-name" required></div>
                        <div class="form-group"><label>نوع الحساب</label>
                            <select id="acc-type" required>
                                <option value="أصل">أصل</option>
                                <option value="خصم">خصم (التزام)</option>
                                <option value="إيرادات">إيرادات</option>
                                <option value="مصروفات">مصروفات</option>
                                <option value="حقوق ملكية">حقوق ملكية</option>
                            </select>
                        </div>
                        <div class="form-group" style="align-self: flex-end;"><button type="submit" class="btn btn-success">إضافة حساب</button></div>
                    </form>
                </div>
                <div class="card">
                    <h2>دليل الحسابات</h2>
                    <div class="table-container">
                        <table id="accounts-table">
                            <thead><tr><th>رقم الحساب</th><th>اسم الحساب</th><th>النوع</th><th>الرصيد</th><th>إجراءات</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sales-view" class="view">
                <div class="card">
                    <h2>إنشاء فاتورة مبيعات جديدة</h2>
                    <form id="add-invoice-form" class="form-grid">
                        <div class="form-group"><label>اسم العميل</label><input type="text" id="invoice-customer" required></div>
                        <div class="form-group"><label>اسم المنتج</label><input type="text" id="invoice-product" required></div>
                        <div class="form-group"><label>الكمية</label><input type="number" id="invoice-qty" value="1" min="1" required></div>
                        <div class="form-group"><label>الإجمالي</label><input type="number" id="invoice-total" step="0.01" required></div>
                        <div class="form-group" style="align-self: flex-end;"><button type="submit" class="btn btn-success">إنشاء فاتورة</button></div>
                    </form>
                </div>
                <div class="card">
                    <h2>قائمة الفواتير</h2>
                    <div class="table-container">
                        <table id="invoices-table">
                            <thead><tr><th>رقم الفاتورة</th><th>العميل</th><th>المنتج</th><th>التاريخ</th><th>الإجمالي</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>
            
            <section id="purchases-view" class="view">
                <div class="card">
                    <h2>إنشاء فاتورة مشتريات جديدة</h2>
                    <form id="add-bill-form" class="form-grid">
                        <div class="form-group"><label>اسم المورد</label><input type="text" id="bill-supplier" required></div>
                        <div class="form-group"><label>اسم المنتج/الخدمة</label><input type="text" id="bill-product" required></div>
                        <div class="form-group"><label>الكمية</label><input type="number" id="bill-qty" value="1" min="1" required></div>
                        <div class="form-group"><label>الإجمالي</label><input type="number" id="bill-total" step="0.01" required></div>
                        <div class="form-group" style="align-self: flex-end;"><button type="submit" class="btn btn-success">إنشاء فاتورة</button></div>
                    </form>
                </div>
                <div class="card">
                    <h2>قائمة فواتير المشتريات</h2>
                    <div class="table-container">
                        <table id="bills-table">
                            <thead><tr><th>رقم الفاتورة</th><th>المورد</th><th>المنتج/الخدمة</th><th>التاريخ</th><th>الإجمالي</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="journal-view" class="view">
                <div class="card">
                    <h2>إنشاء قيد محاسبي يدوي</h2>
                    <form id="add-journal-form" class="form-grid">
                        <div class="form-group"><label>الحساب المدين</label><select id="journal-debit" required></select></div>
                        <div class="form-group"><label>الحساب الدائن</label><select id="journal-credit" required></select></div>
                        <div class="form-group"><label>المبلغ</label><input type="number" id="journal-amount" step="0.01" required></div>
                        <div class="form-group"><label>الوصف</label><input type="text" id="journal-desc" required></div>
                        <div class="form-group" style="align-self: flex-end;"><button type="submit" class="btn btn-success">تسجيل القيد</button></div>
                    </form>
                </div>
                <div class="card">
                    <h2>دفتر اليومية العام</h2>
                    <div class="table-container">
                        <table id="journal-table">
                            <thead><tr><th>التاريخ</th><th>الوصف</th><th>الحساب المدين</th><th>الحساب الدائن</th><th>المبلغ</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="reports-view" class="view">
                <div class="card">
                    <h2>قائمة الدخل</h2>
                    <button class="btn btn-warning" onclick="generateIncomeStatement()">إنشاء التقرير</button>
                    <div id="income-statement-report" class="report-output" style="display:none;"></div>
                </div>
                <div class="card">
                    <h2>قائمة التغيير في حقوق الملكية</h2>
                    <button class="btn btn-warning" onclick="generateEquityStatement()">إنشاء التقرير</button>
                    <div id="equity-statement-report" class="report-output" style="display:none;"></div>
                </div>
                <div class="card">
                    <h2>الميزانية العمومية</h2>
                    <button class="btn btn-warning" onclick="generateBalanceSheet()">إنشاء التقرير</button>
                    <div id="balance-sheet-report" class="report-output" style="display:none;"></div>
                </div>
            </section>

        </main>
    </div>

    <footer>
        Designed for Zaid Khaled Zaid (AIS) — 2026 ©
    </footer>

    <div class="notification-container" id="notification-container"></div>

    <script>
        // --- مولد النجوم (مأخوذ من كود البورتفوليو) ---
        for(let i=0; i<180; i++){
            let s = document.createElement("div");
            s.className = "stars";
            s.style.top = Math.random() * 100 + "%";
            s.style.left = Math.random() * 100 + "%";
            s.style.animationDelay = Math.random() * 3 + "s";
            document.body.appendChild(s);
        }

        // --- DATA MANAGEMENT (نفس كود الـ JS السابق بدون تعديل في المنطق) ---
        const STORAGE_KEY = 'erpSystemData_Zaid';
        let data = {
            accounts: [],
            transactions: [],
            invoices: [],
            bills: [],
        };

        function loadData() {
            const storedData = localStorage.getItem(STORAGE_KEY);
            if (storedData) {
                data = JSON.parse(storedData);
            } else {
                initializeData();
                saveData();
            }
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function initializeData() {
            // Chart of Accounts
            data.accounts = [
                { id: '1001', name: 'الصندوق', type: 'أصل', balance: 10000 },
                { id: '1002', name: 'البنك', type: 'أصل', balance: 50000 },
                { id: '2001', name: 'ذمم مدينة', type: 'أصل', balance: 0 },
                { id: '3001', name: 'ذمم دائنة', type: 'خصم', balance: 0 },
                { id: '4001', name: 'رأس المال', type: 'حقوق ملكية', balance: 60000 },
                { id: '4002', name: 'سحوبات المالك', type: 'حقوق ملكية', balance: 0 },
                { id: '4003', name: 'إضافات رأس المال', type: 'حقوق ملكية', balance: 0 },
                { id: '5001', name: 'إيرادات المبيعات', type: 'إيرادات', balance: 0 },
                { id: '6001', name: 'مصروفات المشتريات', type: 'مصروفات', balance: 0 },
                { id: '6002', name: 'مصروفات رواتب', type: 'مصروفات', balance: 0 },
            ];
            // Initial Transaction for Capital
            data.transactions.push({
                id: generateId(), date: new Date().toISOString(), description: 'رأس مال أولي',
                debitAccountId: '1001', creditAccountId: '4001', amount: 60000
            });
        }

        // --- UI HELPERS ---
        function showView(viewName) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(`${viewName}-view`).classList.add('active');
            event.target.classList.add('active');

            switch(viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'accounts': renderAccounts(); break;
                case 'sales': renderSales(); break;
                case 'purchases': renderPurchases(); break;
                case 'journal': renderJournal(); break;
                case 'reports': /* Reports are generated on button click */ break;
            }
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.appendChild(notification);
            setTimeout(() => notification.remove(), 3500);
        }

        function generateId() {
            return 'T' + Date.now();
        }

        function populateAccountSelect(selectElementId) {
            const select = document.getElementById(selectElementId);
            select.innerHTML = '<option value="">اختر حساباً...</option>';
            data.accounts.forEach(acc => {
                const option = document.createElement('option');
                option.value = acc.id;
                option.textContent = `${acc.id} - ${acc.name}`;
                select.appendChild(option);
            });
        }

        // --- ACCOUNTING LOGIC ---
        function createTransaction(debitAccId, creditAccId, amount, description) {
            const debitAcc = data.accounts.find(a => a.id === debitAccId);
            const creditAcc = data.accounts.find(a => a.id === creditAccId);

            if (!debitAcc || !creditAcc) {
                showNotification('حساب مدين أو دائن غير صحيح!', 'error');
                return false;
            }
            if (debitAccId === creditAccId) {
                showNotification('لا يمكن أن يكون الحساب المدين والدائن نفس الحساب!', 'error');
                return false;
            }

            // Update account balances
            if (debitAcc.type === 'أصل' || debitAcc.type === 'مصروفات' || debitAcc.type === 'سحوبات المالك') {
                debitAcc.balance += amount;
            } else { // خصم, إيرادات, حقوق ملكية (except سحوبات)
                debitAcc.balance -= amount;
            }

            if (creditAcc.type === 'أصل' || creditAcc.type === 'مصروفات' || creditAcc.type === 'سحوبات المالك') {
                creditAcc.balance -= amount;
            } else { // خصم, إيرادات, حقوق ملكية (except سحوبات)
                creditAcc.balance += amount;
            }

            // Add to transaction log
            data.transactions.push({
                id: generateId(),
                date: new Date().toISOString(),
                description,
                debitAccountId: debitAccId,
                creditAccountId: creditAccId,
                amount
            });
            return true;
        }

        // --- RENDER FUNCTIONS ---
        function renderDashboard() {
            const revenueAcc = data.accounts.find(a => a.id === '5001');
            const expenseAccs = data.accounts.filter(a => a.type === 'مصروفات');
            const cashAcc = data.accounts.find(a => a.id === '1001');

            const totalRevenue = revenueAcc ? Math.abs(revenueAcc.balance) : 0;
            const totalExpenses = expenseAccs.reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
            const netProfit = totalRevenue - totalExpenses;
            const cashBalance = cashAcc ? cashAcc.balance : 0;

            document.getElementById('total-revenue').textContent = totalRevenue.toFixed(2);
            document.getElementById('total-expenses').textContent = totalExpenses.toFixed(2);
            document.getElementById('net-profit').textContent = netProfit.toFixed(2);
            document.getElementById('cash-balance').textContent = cashBalance.toFixed(2);

            const recentTBody = document.querySelector('#recent-transactions-table tbody');
            recentTBody.innerHTML = '';
            data.transactions.slice(-5).reverse().forEach(t => {
                const row = recentTBody.insertRow();
                row.insertCell(0).textContent = new Date(t.date).toLocaleDateString('ar-SA');
                row.insertCell(1).textContent = t.description;
                row.insertCell(2).textContent = t.amount.toFixed(2);
            });
        }

        function renderAccounts() {
            const tbody = document.querySelector('#accounts-table tbody');
            tbody.innerHTML = '';
            data.accounts.forEach(acc => {
                const row = tbody.insertRow();
                row.id = `account-row-${acc.id}`;
                row.innerHTML = `
                    <td>${acc.id}</td>
                    <td>${acc.name}</td>
                    <td>${acc.type}</td>
                    <td>${acc.balance.toFixed(2)}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="editAccount('${acc.id}')">تعديل</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAccount('${acc.id}')">حذف</button>
                    </td>
                `;
            });
        }
        
        function editAccount(accountId) {
            const account = data.accounts.find(a => a.id === accountId);
            if (!account) return;
            
            const row = document.getElementById(`account-row-${accountId}`);
            
            row.innerHTML = `
                <td><input type="text" id="edit-id-${accountId}" value="${account.id}" class="editable-input"></td>
                <td><input type="text" id="edit-name-${accountId}" value="${account.name}" class="editable-input"></td>
                <td>
                    <select id="edit-type-${accountId}" class="editable-input">
                        <option value="أصل" ${account.type === 'أصل' ? 'selected' : ''}>أصل</option>
                        <option value="خصم" ${account.type === 'خصم' ? 'selected' : ''}>خصم (التزام)</option>
                        <option value="إيرادات" ${account.type === 'إيرادات' ? 'selected' : ''}>إيرادات</option>
                        <option value="مصروفات" ${account.type === 'مصروفات' ? 'selected' : ''}>مصروفات</option>
                        <option value="حقوق ملكية" ${account.type === 'حقوق ملكية' ? 'selected' : ''}>حقوق ملكية</option>
                    </select>
                </td>
                <td><input type="number" id="edit-balance-${accountId}" value="${account.balance}" class="editable-input" step="0.01"></td>
                <td>
                    <button class="btn btn-sm btn-success" onclick="saveAccount('${accountId}')">حفظ</button>
                    <button class="btn btn-sm" onclick="renderAccounts()">إلغاء</button>
                </td>
            `;
        }

        function saveAccount(accountId) {
            const account = data.accounts.find(a => a.id === accountId);
            const newId = document.getElementById(`edit-id-${accountId}`).value;
            const newName = document.getElementById(`edit-name-${accountId}`).value;
            const newType = document.getElementById(`edit-type-${accountId}`).value;
            const newBalance = parseFloat(document.getElementById(`edit-balance-${accountId}`).value);
            
            if (!newId || !newName) {
                showNotification('رقم الحساب واسمه لا يمكن أن يكونا فارغين', 'error');
                return;
            }
            
            // Check if new ID conflicts with another account
            if (newId !== accountId && data.accounts.some(a => a.id === newId)) {
                showNotification('رقم الحساب هذا مستخدم بالفعل!', 'error');
                return;
            }
            
            account.id = newId;
            account.name = newName;
            account.type = newType;
            account.balance = newBalance;
            
            // Update transactions if ID changed
            if (newId !== accountId) {
                data.transactions.forEach(t => {
                    if (t.debitAccountId === accountId) t.debitAccountId = newId;
                    if (t.creditAccountId === accountId) t.creditAccountId = newId;
                });
            }
            
            saveData();
            renderAccounts();
            showNotification('تم تحديث الحساب بنجاح');
        }

        function deleteAccount(accountId) {
            const account = data.accounts.find(a => a.id === accountId);
            if (account.balance !== 0) {
                showNotification('لا يمكن حذف حساب له رصيد!', 'error');
                return;
            }
            const hasTransactions = data.transactions.some(t => t.debitAccountId === accountId || t.creditAccountId === accountId);
            if (hasTransactions) {
                showNotification('لا يمكن حذف حساب مرتبط بعمليات محاسبية!', 'error');
                return;
            }

            if (confirm('هل أنت متأكد من حذف هذا الحساب؟')) {
                data.accounts = data.accounts.filter(a => a.id !== accountId);
                saveData();
                renderAccounts();
                showNotification('تم حذف الحساب بنجاح');
            }
        }


        function renderSales() {
            const tbody = document.querySelector('#invoices-table tbody');
            tbody.innerHTML = '';
            data.invoices.forEach(inv => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = inv.id;
                row.insertCell(1).textContent = inv.customerName;
                row.insertCell(2).textContent = inv.productName;
                row.insertCell(3).textContent = new Date(inv.date).toLocaleDateString('ar-SA');
                row.insertCell(4).textContent = inv.total.toFixed(2);
            });
        }

        function renderPurchases() {
            const tbody = document.querySelector('#bills-table tbody');
            tbody.innerHTML = '';
            data.bills.forEach(bill => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = bill.id;
                row.insertCell(1).textContent = bill.supplierName;
                row.insertCell(2).textContent = bill.productName;
                row.insertCell(3).textContent = new Date(bill.date).toLocaleDateString('ar-SA');
                row.insertCell(4).textContent = bill.total.toFixed(2);
            });
        }
        
        function renderJournal() {
            populateAccountSelect('journal-debit');
            populateAccountSelect('journal-credit');
            
            const tbody = document.querySelector('#journal-table tbody');
            tbody.innerHTML = '';
            data.transactions.forEach(t => {
                const row = tbody.insertRow();
                const debitAcc = data.accounts.find(a => a.id === t.debitAccountId);
                const creditAcc = data.accounts.find(a => a.id === t.creditAccountId);
                row.insertCell(0).textContent = new Date(t.date).toLocaleDateString('ar-SA');
                row.insertCell(1).textContent = t.description;
                row.insertCell(2).textContent = debitAcc ? debitAcc.name : 'N/A';
                row.insertCell(3).textContent = creditAcc ? creditAcc.name : 'N/A';
                row.insertCell(4).textContent = t.amount.toFixed(2);
            });
        }

        // --- REPORT GENERATORS ---
        function generateIncomeStatement() {
            const revenueAcc = data.accounts.find(a => a.id === '5001');
            const expenseAccs = data.accounts.filter(a => a.type === 'مصروفات');

            const totalRevenue = Math.abs(revenueAcc.balance);
            const totalExpenses = expenseAccs.reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
            const net = totalRevenue - totalExpenses;

            const reportDiv = document.getElementById('income-statement-report');
            reportDiv.innerHTML = `
                <h3>قائمة الدخل عن الفترة الحالية</h3>
                <p>إجمالي الإيرادات: <span>${totalRevenue.toFixed(2)}</span></p>
                <p>إجمالي المصروفات: <span>${totalExpenses.toFixed(2)}</span></p>
                <p class="total">صافي الربح/الخسارة: <span>${net.toFixed(2)} (${net >= 0 ? 'ربح' : 'خسارة'})</span></p>
            `;
            reportDiv.style.display = 'block';
            showNotification('تم إنشاء قائمة الدخل بنجاح');
        }

        function generateEquityStatement() {
            const capitalAcc = data.accounts.find(a => a.id === '4001');
            const drawingsAcc = data.accounts.find(a => a.id === '4002');
            const additionsAcc = data.accounts.find(a => a.id === '4003');
            const revenueAcc = data.accounts.find(a => a.id === '5001');
            const expenseAccs = data.accounts.filter(a => a.type === 'مصروفات');

            const beginningCapital = Math.abs(capitalAcc.balance) - Math.abs(drawingsAcc.balance) - Math.abs(additionsAcc.balance);
            const netIncome = Math.abs(revenueAcc.balance) - expenseAccs.reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
            const drawings = Math.abs(drawingsAcc.balance);
            const additions = Math.abs(additionsAcc.balance);
            const endingCapital = beginningCapital + netIncome + additions - drawings;

            const reportDiv = document.getElementById('equity-statement-report');
            reportDiv.innerHTML = `
                <h3>قائمة التغيير في حقوق الملكية</h3>
                <p>رأس المال في بداية الفترة: <span>${beginningCapital.toFixed(2)}</span></p>
                <p>يضاف: صافي الربح: <span>${netIncome.toFixed(2)}</span></p>
                <p>يضاف: إضافات رأس المال: <span>${additions.toFixed(2)}</span></p>
                <p>يطرح: سحوبات المالك: <span>${drawings.toFixed(2)}</span></p>
                <p class="total">رأس المال في نهاية الفترة: <span>${endingCapital.toFixed(2)}</span></p>
            `;
            reportDiv.style.display = 'block';
            showNotification('تم إنشاء قائمة التغيير في حقوق الملكية بنجاح');
        }

        function generateBalanceSheet() {
            const assetAccounts = data.accounts.filter(a => a.type === 'أصل');
            const liabilityAccounts = data.accounts.filter(a => a.type === 'خصم');
            const equityAccounts = data.accounts.filter(a => a.type === 'حقوق ملكية');

            const totalAssets = assetAccounts.reduce((sum, acc) => sum + acc.balance, 0);
            const totalLiabilities = liabilityAccounts.reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
            const totalEquity = equityAccounts.reduce((sum, acc) => sum + Math.abs(acc.balance), 0);
            
            const reportDiv = document.getElementById('balance-sheet-report');
            reportDiv.innerHTML = `
                <h3>الميزانية العمومية</h3>
                <div style="display: flex; justify-content: space-between; gap: 20px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 250px;">
                        <h4 style="color: var(--success-color); margin-bottom:10px;">الأصول</h4>
                        ${assetAccounts.map(acc => `<p>${acc.name}: ${acc.balance.toFixed(2)}</p>`).join('')}
                        <p class="total">إجمالي الأصول: <span>${totalAssets.toFixed(2)}</span></p>
                    </div>
                    <div style="flex: 1; min-width: 250px;">
                        <h4 style="color: var(--warning-color); margin-bottom:10px;">الخصوم وحقوق الملكية</h4>
                        <h5 style="margin-top:10px; color:#ccc;">الخصوم</h5>
                        ${liabilityAccounts.map(acc => `<p>${acc.name}: ${Math.abs(acc.balance).toFixed(2)}</p>`).join('')}
                        <p class="total" style="font-size:1rem; border-top:1px dashed #555;">إجمالي الخصوم: <span>${totalLiabilities.toFixed(2)}</span></p>
                        
                        <h5 style="margin-top:15px; color:#ccc;">حقوق الملكية</h5>
                        ${equityAccounts.map(acc => `<p>${acc.name}: ${Math.abs(acc.balance).toFixed(2)}</p>`).join('')}
                        <p class="total" style="font-size:1rem; border-top:1px dashed #555;">إجمالي حقوق الملكية: <span>${totalEquity.toFixed(2)}</span></p>
                        
                        <p class="total" style="margin-top:20px; border-top: 2px solid white;">إجمالي الخصوم وحقوق الملكية: <span>${(totalLiabilities + totalEquity).toFixed(2)}</span></p>
                    </div>
                </div>
            `;
            reportDiv.style.display = 'block';
            showNotification('تم إنشاء الميزانية العمومية بنجاح');
        }


        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            renderDashboard();

            // Add Account Form
            document.getElementById('add-account-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const newAccount = {
                    id: document.getElementById('acc-number').value,
                    name: document.getElementById('acc-name').value,
                    type: document.getElementById('acc-type').value,
                    balance: 0
                };
                if (data.accounts.find(a => a.id === newAccount.id)) {
                    showNotification('رقم الحساب موجود بالفعل!', 'error');
                    return;
                }
                data.accounts.push(newAccount);
                saveData();
                renderAccounts();
                this.reset();
                showNotification('تم إضافة الحساب بنجاح');
            });

            // Add Invoice Form
            document.getElementById('add-invoice-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const customerName = document.getElementById('invoice-customer').value;
                const productName = document.getElementById('invoice-product').value;
                const total = parseFloat(document.getElementById('invoice-total').value);
                
                const invoice = { id: 'INV' + generateId(), customerName, productName, date: new Date().toISOString(), total };
                data.invoices.push(invoice);

                if (createTransaction('2001', '5001', total, `فاتورة مبيعات رقم ${invoice.id} للعميل ${customerName}`)) {
                    saveData();
                    renderSales();
                    this.reset();
                    showNotification(`تم إنشاء فاتورة مبيعات رقم ${invoice.id} بنجاح`);
                }
            });
            
            // Add Bill Form
            document.getElementById('add-bill-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const supplierName = document.getElementById('bill-supplier').value;
                const productName = document.getElementById('bill-product').value;
                const total = parseFloat(document.getElementById('bill-total').value);
                
                const bill = { id: 'BLL' + generateId(), supplierName, productName, date: new Date().toISOString(), total };
                data.bills.push(bill);

                if (createTransaction('6001', '3001', total, `فاتورة مشتريات رقم ${bill.id} من المورد ${supplierName}`)) {
                    saveData();
                    renderPurchases();
                    this.reset();
                    showNotification(`تم إنشاء فاتورة مشتريات رقم ${bill.id} بنجاح`);
                }
            });

            // Add Journal Form
            document.getElementById('add-journal-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const debitId = document.getElementById('journal-debit').value;
                const creditId = document.getElementById('journal-credit').value;
                const amount = parseFloat(document.getElementById('journal-amount').value);
                const desc = document.getElementById('journal-desc').value;

                if (createTransaction(debitId, creditId, amount, desc)) {
                    saveData();
                    renderJournal();
                    this.reset();
                    showNotification('تم تسجيل القيد المحاسبي بنجاح');
                }
            });
        });
    </script>

</body>
</html>
